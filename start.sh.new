#!/bin/bash
# Start script voor Week 1 & 2 Project - Docker Deployment

echo "=== Week 1 & 2 Project - Docker Deployment ==="
echo "Starting Webserver, Database and Office VMs..."

# Check of Docker draait
if ! docker info > /dev/null 2>&1; then
    echo "Error: Docker is not running. Please start Docker first."
    exit 1
fi

# Stop eventuele bestaande containers
echo "Stopping existing containers..."
docker compose down

# Build en start containers
echo "Building and starting containers..."
docker compose up --build -d

# Wacht tot services klaar zijn
echo "Waiting for services to start..."
sleep 15

# Test database verbinding
echo "Testing database connection..."
for i in {1..30}; do
    if docker exec database-vm mysqladmin ping -h"localhost" --silent; then
        echo "Database is ready!"
        break
    fi
    echo "Waiting for database... ($i/30)"
    sleep 2
done

# Test webserver
echo "Testing webserver..."
for i in {1..30}; do
    if curl -s http://localhost > /dev/null; then
        echo "Webserver is ready!"
        break
    fi
    echo "Waiting for webserver... ($i/30)"
    sleep 2
done

# Test office container
echo "Testing office container..."
for i in {1..10}; do
    if docker exec office-vm echo "test" > /dev/null 2>&1; then
        echo "Office environment is ready!"
        break
    fi
    echo "Waiting for office environment... ($i/10)"
    sleep 2
done

echo ""
echo "=== Deployment Completed ==="
echo ""
echo "ğŸŒ Website: http://localhost"
echo "ğŸ”’ SSH Webserver: ssh admin@localhost -p 2222 (password: adminpassword123)"
echo "ğŸ”’ SSH Database: ssh dbadmin@localhost -p 2223 (password: dbadminpassword123)"
echo "ğŸ”’ SSH Office: ssh office@localhost -p 2224 (password: officepassword123)"
echo "ğŸ—„ï¸  MySQL: localhost:3306 (user: webapp_user, password: secure_password123)"
echo "ğŸ–¥ï¸  Office RDP: localhost:3389 (user: office, password: officepassword123)"
echo "ğŸ–±ï¸  Office VNC: localhost:5901"
echo ""
echo "ğŸ“‹ Test Accounts:"
echo "   Admin: admin / password123"
echo "   User:  testuser / password123"
echo ""
echo "ğŸ¢ Office Tools:"
echo "   â€¢ LibreOffice Suite (Calc, Writer, Base)"
echo "   â€¢ Database Tools: python3 /home/office/Documents/Scripts/db_extractor.py"
echo "   â€¢ Website Tools: python3 /home/office/Documents/Scripts/website_tool.py"
echo "   â€¢ MySQL Client: mysql -h database -u webapp_user -p"
echo ""
echo "ğŸ›¡ï¸  ModSecurity WAF is enabled and protecting the webserver"
echo "ğŸ“Š View logs: docker compose logs -f"
echo "ğŸ›‘ Stop services: docker compose down"
