# Linux iptables Router Configuration  
# Advanced Network Segmentation Rules

# Network Segments:
# DMZ Network:        172.20.1.0/24 (Webserver)
# Internal Network:   172.20.2.0/24 (Database) 
# Office Network:     172.20.3.0/24 (Office Tools)
# Management Network: 172.20.4.0/24 (Admin Access + WireGuard VPN)

[INTERFACES]
DMZ_INTERFACE=172.20.1.1/24
DATABASE_SERVER_INTERFACE=172.20.2.1/24
OFFICE_INTERFACE=172.20.3.1/24
MANAGEMENT_INTERFACE=172.20.4.1/24
WIREGUARD_INTERFACE=wg0:172.20.4.1/24
EXTERNAL_INTERFACE=eth0


[IPTABLES_RULES]

# Flush alle bestaande rules en reset naar default DROP beleid
iptables -F
iptables -X
iptables -t nat -F
iptables -t nat -X
iptables -t mangle -F
iptables -t mangle -X

# Default policies - ALLES BLOKKEREN
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

# Loopback interface toestaan (voor lokale services)
iptables -A INPUT -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT

# ESTABLISHED en RELATED connections toestaan (voor terugkerend verkeer)
iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
iptables -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# ===== EXTERNE TOEGANG RESTRICTIES =====

# Externe toegang tot DMZ webserver (HTTP/HTTPS)
iptables -A FORWARD -s 172.20.0.0/16 -d 172.20.1.10 -p tcp -m multiport --dports 80,443 -j ACCEPT

# Blokkeer rest van management subnet naar andere netwerken (indien gewenst)
iptables -A FORWARD -s 172.20.0.0/16 ! -d 172.20.1.10 -j LOG --log-prefix "MGMT-OTHER-BLOCK: " --log-level 4
iptables -A FORWARD -s 172.20.0.0/16 -j DROP

# ===== MANAGEMENT TOEGANG - BEPERKT =====

# Management subnet mag ALLEEN SSH toegang naar alle omgevingen
iptables -A FORWARD -s 172.20.4.0/24 -d 172.20.1.0/24 -p tcp --dport 22 -j ACCEPT
iptables -A FORWARD -s 172.20.4.0/24 -d 172.20.2.0/24 -p tcp --dport 22 -j ACCEPT
iptables -A FORWARD -s 172.20.4.0/24 -d 172.20.3.0/24 -p tcp --dport 22 -j ACCEPT

# Management subnet mag toegang tot extern gepubliceerde website (DMZ webserver)
iptables -A FORWARD -s 172.20.4.0/24 -d 172.20.1.10 -p tcp -m multiport --dports 80,443 -j ACCEPT

# WireGuard VPN server toegang vanaf extern
iptables -A INPUT -i eth0 -p udp --dport 51820 -j ACCEPT

# BLOKKEREN: Office toegang tot firewall zelf
iptables -A INPUT -s 172.20.4.0/24 -j LOG --log-prefix "OFFICE-FW-BLOCK: " --log-level 4
iptables -A INPUT -s 172.20.4.0/24 -j DROP

# BLOKKEREN: Alle andere management toegang
iptables -A FORWARD -s 172.20.4.0/24 -j LOG --log-prefix "MGMT-DENY: " --log-level 4
iptables -A FORWARD -s 172.20.4.0/24 -j DROP

# ===== KANTOOR NETWERK RESTRICTIES =====

# Office netwerk toegang - BEPERKT volgens nieuwe specificaties
# Office mag toegang tot extern gepubliceerde website (via externe route)
iptables -A FORWARD -s 172.20.3.0/24 -d 172.20.1.10 -p tcp -m multiport --dports 80,443 -j ACCEPT

# Office mag toegang tot database (lezen/schrijven)
iptables -A FORWARD -s 172.20.3.0/24 -d 172.20.2.10 -p tcp --dport 3306 -j ACCEPT

# Office mag toegang tot internet (eth0)
iptables -A FORWARD -s 172.20.3.0/24 -o eth0 -j ACCEPT

# BLOKKEREN: Office toegang tot DMZ webserver (direct)
iptables -A FORWARD -s 172.20.3.0/24 -j LOG --log-prefix "OFFICE-DROP: " --log-level 4
iptables -A FORWARD -s 172.20.3.0/24 -j DROP

# BLOKKEREN: Office toegang tot firewall zelf
iptables -A INPUT -s 172.20.3.0/24 -j LOG --log-prefix "OFFICE-FW-DROP: " --log-level 4
iptables -A INPUT -s 172.20.3.0/24 -j DROP


# ===== DATABASE SERVER RESTRICTIES =====
# BLOKKEREN: Database Server uitgaand verkeer
iptables -A FORWARD -s 172.20.2.0/24 -o eth0 -j LOG --log-prefix "DB-DROP: " --log-level 4
iptables -A FORWARD -s 172.20.2.0/24 -d 172.20.1.0/24 -j LOG --log-prefix "DB-DMZ-BLOCK: " --log-level 4
iptables -A FORWARD -s 172.20.2.0/24 -d 172.20.3.0/24 -j LOG --log-prefix "DB-OFFICE-BLOCK: " --log-level 4
iptables -A FORWARD -s 172.20.2.0/24 -d 172.20.4.0/24 -j LOG --log-prefix "DB-MGMT-BLOCK: " --log-level 4
iptables -A FORWARD -s 172.20.2.0/24 -j DROP

# BLOKKEREN: Database toegang tot firewall zelf
iptables -A INPUT -s 172.20.2.0/24 -j LOG --log-prefix "DB-FW-BLOCK: " --log-level 4
iptables -A INPUT -s 172.20.2.0/24 -j DROP


# ===== DMZ WEBSERVER RESTRICTIES =====
# DMZ Webserver mag ALLEEN reageren op inkomende HTTP(S) verbindingen

# BLOKKEREN: DMZ Server uitgaand verkeer
iptables -A FORWARD -s 172.20.1.0/24 -o eth0 -j LOG --log-prefix "DMZ-ETH-DROP: " --log-level 4
iptables -A FORWARD -s 172.20.1.0/24 -d 172.20.2.0/24 -j LOG --log-prefix "DMZ-DB-BLOCK: " --log-level 4
iptables -A FORWARD -s 172.20.1.0/24 -d 172.20.3.0/24 -j LOG --log-prefix "DMZ-OFFICE-BLOCK: " --log-level 4
iptables -A FORWARD -s 172.20.1.0/24 -d 172.20.4.0/24 -j LOG --log-prefix "DMZ-MGMT-BLOCK: " --log-level 4
iptables -A FORWARD -s 172.20.1.0/24 -j DROP

# BLOKKEREN: DMZ toegang tot firewall zelf
iptables -A INPUT -s 172.20.1.0/24 -j LOG --log-prefix "DMZ-FW-BLOCK: " --log-level 4
iptables -A INPUT -s 172.20.1.0/24 -j DROP

[NAT_RULES] 

# ===== PORT FORWARDING VOOR EXTERNE TOEGANG =====

# Website toegang (HTTP/HTTPS) - ALLEEN naar DMZ webserver
EXT_HTTP_TO_DMZ="iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -j DNAT --to-destination 172.20.1.10:80"
EXT_HTTPS_TO_DMZ="iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 443 -j DNAT --to-destination 172.20.1.10:443"

# ===== UITGAANDE NAT (MASQUERADING) =====
OUT_NAT_OFFICE="iptables -t nat -A POSTROUTING -s 172.20.3.0/24 -o eth0 -j MASQUERADE"

# ===== WIREGUARD VPN NAT =====
VPN_NAT="iptables -t nat -A POSTROUTING -s 172.20.4.0/24 -o eth+ ! -d 172.20.0.0/16 -j MASQUERADE"


[LOGGING]
LOG_LEVEL=INFO
LOG_BLOCKED_CONNECTIONS=true
LOG_ALLOWED_CONNECTIONS=false
LOG_PREFIX_BLOCKED=IPTABLES-BLOCKED
LOG_PREFIX_SSH_BRUTE=SSH-BRUTE-FORCE
LOG_RATE_LIMIT=5_per_minute
SYSLOG_FACILITY=local0

[PERSISTENCE]  
IPTABLES_SAVE_FILE=/etc/iptables/rules.v4
IP6TABLES_SAVE_FILE=/etc/iptables/rules.v6
AUTO_RESTORE_ON_BOOT=true

[MONITORING]
CONNECTION_TRACKING_FILE=/proc/sys/net/netfilter/nf_conntrack_count
CONNECTION_TRACKING_MAX=/proc/sys/net/netfilter/nf_conntrack_max
ENABLE_PERFORMANCE_MONITORING=true

[WIREGUARD_VPN]
VPN_SUBNET=172.20.4.0/24
VPN_SERVER_IP=172.20.4.1
VPN_PORT=51820
VPN_DNS=8.8.8.8,8.8.4.4
VPN_KEEPALIVE=25

# VPN Access Rules - BEPERKT
VPN_ACCESS_DMZ=ssh_only_and_website
VPN_ACCESS_INTERNAL=ssh_only
VPN_ACCESS_OFFICE=ssh_only
VPN_ACCESS_MANAGEMENT=enabled
