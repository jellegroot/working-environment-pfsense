# Linux iptables Router Configuration  
# Advanced Network Segmentation Rules

# Network Segments:
# DMZ Network:      172.20.1.0/24 (Webserver)
# Internal Network: 172.20.2.0/24 (Database) 
# Office Network:   172.20.3.0/24 (Office Tools)

[INTERFACES]
DMZ_INTERFACE=172.20.1.1/24
INTERNAL_INTERFACE=172.20.2.1/24
OFFICE_INTERFACE=172.20.3.1/24

[IPTABLES_RULES]
# Custom chains for organized rule management  
CUSTOM_CHAINS=DMZ-RULES,INTERNAL-RULES,OFFICE-RULES,LOG-DROP

# Security features
ANTI_SPOOFING=enabled
CONNECTION_TRACKING=enabled
RATE_LIMITING_SSH=4_connections_per_60_seconds
PORT_SCAN_PROTECTION=enabled

# Allow HTTP/HTTPS to DMZ from anywhere (with connection tracking)
ALLOW_HTTP_DMZ=tcp:80:172.20.1.0/24:state_NEW_ESTABLISHED
ALLOW_HTTPS_DMZ=tcp:443:172.20.1.0/24:state_NEW_ESTABLISHED

# Allow Office to access DMZ (website)  
ALLOW_OFFICE_TO_DMZ=tcp:80,443:172.20.1.0/24:172.20.3.0/24

# Allow DMZ to access Internal (database with connection tracking)
ALLOW_DMZ_TO_INTERNAL=tcp:3306:172.20.2.0/24:172.20.1.0/24:state_NEW_ESTABLISHED

# Allow Office to access Internal (database)
ALLOW_OFFICE_TO_INTERNAL=tcp:3306:172.20.2.0/24:172.20.3.0/24

# Allow SSH access with rate limiting (management)
ALLOW_SSH_RATE_LIMITED=tcp:22:0.0.0.0/0:rate_limit_enabled

# DNS resolution for all networks
ALLOW_DNS=udp:53:0.0.0.0/0

# Block everything else by default (DROP policy)
DEFAULT_POLICY=DROP

[NAT_RULES] 
# DNAT (Destination NAT) for port forwarding
HTTP_DNAT=eth0:80:172.20.1.10:80
HTTPS_DNAT=eth0:443:172.20.1.10:443
SSH_WEBSERVER_DNAT=eth0:2222:172.20.1.10:22
SSH_DATABASE_DNAT=eth0:2223:172.20.2.10:22
SSH_OFFICE_DNAT=eth0:2224:172.20.3.10:22
RDP_OFFICE_DNAT=eth0:3389:172.20.3.10:3389
VNC_OFFICE_DNAT=eth0:5901:172.20.3.10:5901

# SNAT (Source NAT) / Masquerading for outbound traffic
SNAT_DMZ=172.20.1.0/24:eth0:MASQUERADE
SNAT_INTERNAL=172.20.2.0/24:eth0:MASQUERADE
SNAT_OFFICE=172.20.3.0/24:eth0:MASQUERADE

# Restricted database access (only from office network)
MYSQL_RESTRICTED_DNAT=eth0:3306:172.20.2.10:3306:source_172.20.3.0/24

[LOGGING]
LOG_LEVEL=INFO
LOG_BLOCKED_CONNECTIONS=true
LOG_ALLOWED_CONNECTIONS=false
LOG_PREFIX_BLOCKED=IPTABLES-BLOCKED
LOG_PREFIX_SSH_BRUTE=SSH-BRUTE-FORCE
LOG_RATE_LIMIT=5_per_minute
SYSLOG_FACILITY=local0

[PERSISTENCE]  
IPTABLES_SAVE_FILE=/etc/iptables/rules.v4
IP6TABLES_SAVE_FILE=/etc/iptables/rules.v6
AUTO_RESTORE_ON_BOOT=true

[MONITORING]
CONNECTION_TRACKING_FILE=/proc/sys/net/netfilter/nf_conntrack_count
CONNECTION_TRACKING_MAX=/proc/sys/net/netfilter/nf_conntrack_max
ENABLE_PERFORMANCE_MONITORING=true
