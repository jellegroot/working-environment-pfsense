# Linux iptables Router Configuration  
# Advanced Network Segmentation Rules

# Network Segments:
# DMZ Network:        172.20.1.0/24 (Webserver)
# Internal Network:   172.20.2.0/24 (Database) 
# Office Network:     172.20.3.0/24 (Office Tools)
# Management Network: 172.20.4.0/24 (Admin Access + WireGuard VPN)

[INTERFACES]
DMZ_INTERFACE=172.20.1.1/24
DATABASE_SERVER_INTERFACE=172.20.2.1/24
OFFICE_INTERFACE=172.20.3.1/24
MANAGEMENT_INTERFACE=172.20.4.1/24
WIREGUARD_INTERFACE=wg0:172.20.4.1/24
EXTERNAL_INTERFACE=eth0


[IPTABLES_RULES]

# 1. Flush alle bestaande rules en reset naar default DROP beleid
iptables -F
iptables -X
iptables -t nat -F
iptables -t nat -X
iptables -t mangle -F
iptables -t mangle -X

# 2. Default policies - ALLES BLOKKEREN
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

# 3. Loopback interface toestaan (voor lokale services)
iptables -A INPUT -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT

# 4. ESTABLISHED en RELATED connections toestaan (voor terugkerend verkeer)
iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
iptables -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# ===== EXTERNE TOEGANG RESTRICTIES =====

# 5. HTTP/HTTPS vanaf extern ALLEEN naar webserver in DMZ
iptables -A FORWARD -i eth0 -d 172.20.1.10 -p tcp --dport 80 -m conntrack --ctstate NEW,ESTABLISHED -j ACCEPT
iptables -A FORWARD -i eth0 -d 172.20.1.10 -p tcp --dport 443 -m conntrack --ctstate NEW,ESTABLISHED -j ACCEPT

# 6. NAT rules voor HTTP/HTTPS naar DMZ webserver
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -j DNAT --to-destination 172.20.1.10:80
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 443 -j DNAT --to-destination 172.20.1.10:443

# 7. BLOKKEREN: Extern naar firewall zelf (router management)
iptables -A INPUT -i eth0 -p tcp --dport 22 -j LOG --log-prefix "EXTERN-SSH-BLOCK: " --log-level 4
iptables -A INPUT -i eth0 -p tcp --dport 22 -j DROP
iptables -A INPUT -i eth0 -p tcp --dport 443 -j LOG --log-prefix "EXTERN-HTTPS-BLOCK: " --log-level 4  
iptables -A INPUT -i eth0 -p tcp --dport 443 -j DROP
iptables -A INPUT -i eth0 -p tcp --dport 80 -j LOG --log-prefix "EXTERN-HTTP-BLOCK: " --log-level 4
iptables -A INPUT -i eth0 -p tcp --dport 80 -j DROP

# 8. BLOKKEREN: Extern rechtstreeks naar andere netwerken (alleen van buiten interne ranges)
iptables -A FORWARD -s ! 172.20.0.0/16 -d 172.20.2.0/24 -j LOG --log-prefix "EXTERN-DB-BLOCK: " --log-level 4
iptables -A FORWARD -s ! 172.20.0.0/16 -d 172.20.2.0/24 -j DROP
iptables -A FORWARD -s ! 172.20.0.0/16 -d 172.20.3.0/24 -j LOG --log-prefix "EXTERN-OFFICE-BLOCK: " --log-level 4
iptables -A FORWARD -s ! 172.20.0.0/16 -d 172.20.3.0/24 -j DROP
iptables -A FORWARD -s ! 172.20.0.0/16 -d 172.20.4.0/24 -j LOG --log-prefix "EXTERN-MGMT-BLOCK: " --log-level 4
iptables -A FORWARD -s ! 172.20.0.0/16 -d 172.20.4.0/24 -j DROP

# 9. BLOKKEREN: Directe toegang tot DMZ (behalve via NAT naar webserver)
iptables -A FORWARD -i eth0 -d 172.20.1.0/24 ! -d 172.20.1.10 -j LOG --log-prefix "EXTERN-DMZ-BLOCK: " --log-level 4
iptables -A FORWARD -i eth0 -d 172.20.1.0/24 ! -d 172.20.1.10 -j DROP

# ===== MANAGEMENT TOEGANG - BEPERKT =====

# 10. Management subnet mag ALLEEN SSH toegang naar alle omgevingen
iptables -A FORWARD -s 172.20.4.0/24 -d 172.20.1.0/24 -p tcp --dport 22 -j ACCEPT
iptables -A FORWARD -s 172.20.4.0/24 -d 172.20.2.0/24 -p tcp --dport 22 -j ACCEPT
iptables -A FORWARD -s 172.20.4.0/24 -d 172.20.3.0/24 -p tcp --dport 22 -j ACCEPT

# 11. Management subnet mag toegang tot extern gepubliceerde website (DMZ webserver)
iptables -A FORWARD -s 172.20.4.0/24 -d 172.20.1.10 -p tcp -m multiport --dports 80,443 -j ACCEPT

# 12. Management toegang tot router web interface (HTTPS op router zelf)
iptables -A INPUT -s 172.20.4.0/24 -p tcp -m multiport --dports 80,443 -j ACCEPT

# 13. WireGuard VPN server toegang vanaf extern
iptables -A INPUT -i eth0 -p udp --dport 51820 -j ACCEPT

# 14. BLOKKEREN: Alle andere management toegang
iptables -A FORWARD -s 172.20.4.0/24 -j LOG --log-prefix "MGMT-DENY: " --log-level 4
iptables -A FORWARD -s 172.20.4.0/24 -j DROP

# ===== INTERNE NETWERK SEGMENTATIE =====

# 16. Office netwerk toegang - BEPERKT volgens nieuwe specificaties
# Office mag toegang tot extern gepubliceerde website (via externe route)
iptables -A FORWARD -s 172.20.3.0/24 -d 172.20.1.10 -p tcp -m multiport --dports 80,443 -j ACCEPT
# Office mag toegang tot database (lezen/schrijven)
iptables -A FORWARD -s 172.20.3.0/24 -d 172.20.2.10 -p tcp --dport 3306 -j ACCEPT

# 17. BLOKKEREN: Office toegang tot DMZ webserver (direct)
iptables -A FORWARD -s 172.20.3.0/24 -d 172.20.1.0/24 -j LOG --log-prefix "OFFICE-DMZ-BLOCK: " --log-level 4
iptables -A FORWARD -s 172.20.3.0/24 -d 172.20.1.0/24 -j DROP

# 18. BLOKKEREN: Office toegang tot firewall zelf
iptables -A INPUT -s 172.20.3.0/24 -j LOG --log-prefix "OFFICE-FW-BLOCK: " --log-level 4
iptables -A INPUT -s 172.20.3.0/24 -j DROP

# ===== DATABASE SERVER RESTRICTIES =====
# Database Server mag ALLEEN reageren op inkomende verbindingen, GEEN uitgaande verbindingen

# 19. BLOKKEREN: Database Server toegang tot DMZ
iptables -A FORWARD -s 172.20.2.0/24 -d 172.20.1.0/24 -j LOG --log-prefix "DB-DMZ-BLOCK: " --log-level 4
iptables -A FORWARD -s 172.20.2.0/24 -d 172.20.1.0/24 -j DROP

# 20. BLOKKEREN: Database Server toegang tot Office  
iptables -A FORWARD -s 172.20.2.0/24 -d 172.20.3.0/24 -j LOG --log-prefix "DB-OFFICE-BLOCK: " --log-level 4
iptables -A FORWARD -s 172.20.2.0/24 -d 172.20.3.0/24 -j DROP

# 21. BLOKKEREN: Database Server toegang tot Management
iptables -A FORWARD -s 172.20.2.0/24 -d 172.20.4.0/24 -j LOG --log-prefix "DB-MGMT-BLOCK: " --log-level 4
iptables -A FORWARD -s 172.20.2.0/24 -d 172.20.4.0/24 -j DROP

# 22. BLOKKEREN: Database Server toegang tot Firewall zelf
iptables -A INPUT -s 172.20.2.0/24 -j LOG --log-prefix "DB-FW-BLOCK: " --log-level 4
iptables -A INPUT -s 172.20.2.0/24 -j DROP

# 23. BLOKKEREN: Database Server toegang tot internet (al uitgeschakeld boven)
iptables -A FORWARD -s 172.20.2.0/24 -o eth0 -j LOG --log-prefix "DB-INTERNET-BLOCK: " --log-level 4
iptables -A FORWARD -s 172.20.2.0/24 -o eth0 -j DROP

# ===== DMZ WEBSERVER RESTRICTIES =====
# DMZ Webserver mag ALLEEN reageren op inkomende HTTP(S) verbindingen

# 24. BLOKKEREN: DMZ toegang tot Database (al geblokkeerd door DB restricties boven)
# Extra regel voor duidelijkheid
iptables -A FORWARD -s 172.20.1.0/24 -d 172.20.2.0/24 -j LOG --log-prefix "DMZ-DB-BLOCK: " --log-level 4
iptables -A FORWARD -s 172.20.1.0/24 -d 172.20.2.0/24 -j DROP

# 25. BLOKKEREN: DMZ toegang tot Office
iptables -A FORWARD -s 172.20.1.0/24 -d 172.20.3.0/24 -j LOG --log-prefix "DMZ-OFFICE-BLOCK: " --log-level 4
iptables -A FORWARD -s 172.20.1.0/24 -d 172.20.3.0/24 -j DROP

# 26. BLOKKEREN: DMZ toegang tot Management
iptables -A FORWARD -s 172.20.1.0/24 -d 172.20.4.0/24 -j LOG --log-prefix "DMZ-MGMT-BLOCK: " --log-level 4
iptables -A FORWARD -s 172.20.1.0/24 -d 172.20.4.0/24 -j DROP

# 27. BLOKKEREN: DMZ toegang tot Firewall zelf
iptables -A INPUT -s 172.20.1.0/24 -j LOG --log-prefix "DMZ-FW-BLOCK: " --log-level 4
iptables -A INPUT -s 172.20.1.0/24 -j DROP

# 28. BLOKKEREN: DMZ toegang tot internet
iptables -A FORWARD -s 172.20.1.0/24 -o eth0 -j LOG --log-prefix "DMZ-INTERNET-BLOCK: " --log-level 4
iptables -A FORWARD -s 172.20.1.0/24 -o eth0 -j DROP

# ===== UITWAARDS VERKEER TOESTAAN =====

# 18. Office netwerk beperkte externe toegang (internet + extern gepubliceerde website)
iptables -A FORWARD -s 172.20.3.0/24 -o eth0 -p tcp -m multiport --dports 80,443 -j ACCEPT
iptables -A FORWARD -s 172.20.3.0/24 -o eth0 -p tcp --dport 53 -j ACCEPT
iptables -A FORWARD -s 172.20.3.0/24 -o eth0 -p udp --dport 53 -j ACCEPT
iptables -A FORWARD -s 172.20.3.0/24 -o eth0 -p tcp --dport 22 -j ACCEPT
# Blokkeer andere office uitgaand verkeer
iptables -A FORWARD -s 172.20.3.0/24 -o eth0 -j LOG --log-prefix "OFFICE-OUTBOUND-BLOCK: " --log-level 4
iptables -A FORWARD -s 172.20.3.0/24 -o eth0 -j DROP

# 19. Management netwerk beperkte externe toegang (alleen SSH en HTTP(S))
iptables -A FORWARD -s 172.20.4.0/24 -o eth0 -p tcp --dport 22 -j ACCEPT
iptables -A FORWARD -s 172.20.4.0/24 -o eth0 -p tcp --dport 80 -j ACCEPT
iptables -A FORWARD -s 172.20.4.0/24 -o eth0 -p tcp --dport 443 -j ACCEPT
iptables -A FORWARD -s 172.20.4.0/24 -o eth0 -p tcp --dport 53 -j ACCEPT
iptables -A FORWARD -s 172.20.4.0/24 -o eth0 -p udp --dport 53 -j ACCEPT

# 16. NAT/Masquerading voor uitgaand verkeer
iptables -t nat -A POSTROUTING -s 172.20.1.0/24 -o eth0 -j MASQUERADE
iptables -t nat -A POSTROUTING -s 172.20.2.0/24 -o eth0 -j MASQUERADE
iptables -t nat -A POSTROUTING -s 172.20.3.0/24 -o eth0 -j MASQUERADE  
iptables -t nat -A POSTROUTING -s 172.20.4.0/24 -o eth0 -j MASQUERADE

# ===== LOGGEN VAN GEBLOKKEERDE VERBINDINGEN =====

# 20. Log alle andere geblokkeerde forward attempts
iptables -A FORWARD -j LOG --log-prefix "FORWARD-BLOCK: " --log-level 4 --log-limit 5/minute
iptables -A FORWARD -j DROP

# 21. Log alle andere geblokkeerde input attempts  
iptables -A INPUT -j LOG --log-prefix "INPUT-BLOCK: " --log-level 4 --log-limit 5/minute
iptables -A INPUT -j DROP


[NAT_RULES] 

# ===== PORT FORWARDING VOOR EXTERNE TOEGANG =====

# Website toegang (HTTP/HTTPS) - ALLEEN naar DMZ webserver
EXT_HTTP_TO_DMZ="iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -j DNAT --to-destination 172.20.1.10:80"
EXT_HTTPS_TO_DMZ="iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 443 -j DNAT --to-destination 172.20.1.10:443"

# ===== BEPERKTE SSH TOEGANG VOOR MANAGEMENT (via VPN) =====

# SSH toegang vanaf management netwerk naar interne servers
# Deze regels worden alleen toegepast als bron IP in management subnet zit
MGMT_SSH_WEB="iptables -t nat -A PREROUTING -s 172.20.4.0/24 -p tcp --dport 2222 -j DNAT --to-destination 172.20.1.10:22"
MGMT_SSH_DB="iptables -t nat -A PREROUTING -s 172.20.4.0/24 -p tcp --dport 2223 -j DNAT --to-destination 172.20.2.10:22"
MGMT_SSH_OFFICE="iptables -t nat -A PREROUTING -s 172.20.4.0/24 -p tcp --dport 2224 -j DNAT --to-destination 172.20.3.10:22"

# ===== UITGAANDE NAT (MASQUERADING) =====
OUT_NAT_DMZ="iptables -t nat -A POSTROUTING -s 172.20.1.0/24 -o eth0 -j MASQUERADE"
OUT_NAT_INTERNAL="iptables -t nat -A POSTROUTING -s 172.20.2.0/24 -o eth0 -j MASQUERADE"
OUT_NAT_OFFICE="iptables -t nat -A POSTROUTING -s 172.20.3.0/24 -o eth0 -j MASQUERADE"
OUT_NAT_MGMT="iptables -t nat -A POSTROUTING -s 172.20.4.0/24 -o eth0 -j MASQUERADE"

# ===== WIREGUARD VPN NAT =====
VPN_NAT="iptables -t nat -A POSTROUTING -s 172.20.4.0/24 -o eth+ ! -d 172.20.0.0/16 -j MASQUERADE"

[LOGGING]
LOG_LEVEL=INFO
LOG_BLOCKED_CONNECTIONS=true
LOG_ALLOWED_CONNECTIONS=false
LOG_PREFIX_BLOCKED=IPTABLES-BLOCKED
LOG_PREFIX_SSH_BRUTE=SSH-BRUTE-FORCE
LOG_RATE_LIMIT=5_per_minute
SYSLOG_FACILITY=local0

[PERSISTENCE]  
IPTABLES_SAVE_FILE=/etc/iptables/rules.v4
IP6TABLES_SAVE_FILE=/etc/iptables/rules.v6
AUTO_RESTORE_ON_BOOT=true

[MONITORING]
CONNECTION_TRACKING_FILE=/proc/sys/net/netfilter/nf_conntrack_count
CONNECTION_TRACKING_MAX=/proc/sys/net/netfilter/nf_conntrack_max
ENABLE_PERFORMANCE_MONITORING=true

[WIREGUARD_VPN]
VPN_SUBNET=172.20.4.0/24
VPN_SERVER_IP=172.20.4.1
VPN_PORT=51820
VPN_DNS=8.8.8.8,8.8.4.4
VPN_KEEPALIVE=25

# VPN Access Rules - BEPERKT
VPN_ACCESS_DMZ=ssh_only_and_website
VPN_ACCESS_INTERNAL=ssh_only
VPN_ACCESS_OFFICE=ssh_only
VPN_ACCESS_MANAGEMENT=enabled
